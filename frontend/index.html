<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GuauAI â€” Habla con tu perro</title>
  <meta name="description" content="Motor de IA para entender las vocalizaciones de tu perro"/>
  <meta name="theme-color" content="#7c3aed"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="GuauAI"/>
  <link rel="manifest" href="/manifest.json"/>
  <link rel="apple-touch-icon" href="/icon-192.png"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0a0a0f;
      --card: #13131a;
      --border: #222230;
      --accent: #7c3aed;
      --accent2: #a855f7;
      --green: #22c55e;
      --yellow: #eab308;
      --red: #ef4444;
      --text: #f0f0f5;
      --muted: #888899;
      --radius: 16px;
    }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* HEADER */
    header {
      width: 100%;
      max-width: 500px;
      padding: 2rem 1.5rem 1rem;
      text-align: center;
    }
    .logo-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
    header h1 { font-size: 1.8rem; font-weight: 900; letter-spacing: -0.5px; }
    header h1 span { color: var(--accent2); }
    header p { color: var(--muted); font-size: 0.9rem; margin-top: 0.4rem; }

    /* MAIN CARD */
    .main { width: 100%; max-width: 500px; padding: 0 1rem 4rem; }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 1rem;
    }

    /* DOG PROFILE */
    .profile-row { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
    .profile-row input {
      flex: 1;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.7rem 1rem;
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
    }
    .profile-row input:focus { border-color: var(--accent); }
    .profile-row input::placeholder { color: var(--muted); }

    /* RECORDER */
    .recorder {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.2rem;
    }

    /* WAVEFORM */
    #waveform {
      width: 100%;
      height: 80px;
      border-radius: 12px;
      background: rgba(124,58,237,0.07);
      border: 1px solid var(--border);
    }

    /* RECORD BTN */
    .record-btn {
      width: 80px; height: 80px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      font-size: 1.8rem;
      cursor: pointer;
      position: relative;
      transition: transform 0.15s, box-shadow 0.15s;
      box-shadow: 0 0 0 0 rgba(124,58,237,0.4);
    }
    .record-btn:hover { transform: scale(1.05); }
    .record-btn.recording {
      background: linear-gradient(135deg, #c81e1e, #ef4444);
      animation: pulse-ring 1.5s ease-out infinite;
    }
    @keyframes pulse-ring {
      0% { box-shadow: 0 0 0 0 rgba(239,68,68,0.5); }
      70% { box-shadow: 0 0 0 20px rgba(239,68,68,0); }
      100% { box-shadow: 0 0 0 0 rgba(239,68,68,0); }
    }

    .timer {
      font-size: 1rem;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 2px;
      font-variant-numeric: tabular-nums;
    }
    .timer.recording { color: var(--red); }

    .status-label {
      font-size: 0.8rem;
      color: var(--muted);
      text-align: center;
    }

    /* ANALYZE BTN */
    .analyze-btn {
      width: 100%;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      border: none;
      border-radius: 100px;
      padding: 1rem;
      font-weight: 800;
      font-size: 1rem;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
      display: none;
    }
    .analyze-btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .analyze-btn.visible { display: block; }
    .analyze-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* LOADER */
    .loader {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem 0;
    }
    .loader.visible { display: flex; }
    .spinner {
      width: 40px; height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent2);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loader p { color: var(--muted); font-size: 0.85rem; }

    /* RESULT */
    .result { display: none; }
    .result.visible { display: block; }

    .emotion-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(124,58,237,0.15);
      border: 1px solid rgba(124,58,237,0.3);
      border-radius: 100px;
      padding: 0.4rem 1rem;
      font-weight: 700;
      font-size: 0.85rem;
      color: var(--accent2);
      margin-bottom: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .message-bubble {
      background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(168,85,247,0.1));
      border: 1px solid rgba(124,58,237,0.2);
      border-radius: 16px 16px 16px 4px;
      padding: 1.2rem;
      margin-bottom: 1rem;
    }
    .message-bubble .dog-icon { font-size: 1.5rem; margin-bottom: 0.5rem; display: block; }
    .message-bubble p {
      font-size: 1.1rem;
      font-weight: 600;
      line-height: 1.4;
      color: var(--text);
    }
    .message-bubble .quote-mark { color: var(--accent2); font-size: 1.4rem; line-height: 0; }

    .meta-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .meta-item {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.75rem;
    }
    .meta-item .label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.3rem; }
    .meta-item .value { font-size: 0.9rem; font-weight: 700; }

    .confidence-bar {
      width: 100%;
      height: 6px;
      background: var(--border);
      border-radius: 100px;
      overflow: hidden;
      margin-top: 0.4rem;
    }
    .confidence-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 100px;
      transition: width 1s ease;
    }

    .recommendation {
      background: rgba(34,197,94,0.08);
      border: 1px solid rgba(34,197,94,0.2);
      border-radius: 10px;
      padding: 0.75rem 1rem;
      font-size: 0.85rem;
      color: #86efac;
      display: flex;
      gap: 0.6rem;
      align-items: flex-start;
    }

    .try-again-btn {
      width: 100%;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 100px;
      padding: 0.8rem;
      color: var(--muted);
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      margin-top: 0.75rem;
      transition: border-color 0.2s, color 0.2s;
    }
    .try-again-btn:hover { border-color: var(--accent); color: var(--accent2); }

    /* HISTORY */
    .history-title {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin-bottom: 0.75rem;
    }
    .history-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 0;
      border-bottom: 1px solid var(--border);
    }
    .history-item:last-child { border-bottom: none; }
    .history-emoji { font-size: 1.3rem; }
    .history-info { flex: 1; }
    .history-info .emotion { font-size: 0.85rem; font-weight: 700; text-transform: capitalize; }
    .history-info .time { font-size: 0.75rem; color: var(--muted); }
    .history-info .msg { font-size: 0.8rem; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* ERROR */
    .error-msg {
      background: rgba(239,68,68,0.08);
      border: 1px solid rgba(239,68,68,0.2);
      border-radius: 10px;
      padding: 1rem;
      color: #fca5a5;
      font-size: 0.9rem;
      display: none;
    }
    .error-msg.visible { display: block; }

    /* BOTTOM NAV */
    footer {
      position: fixed;
      bottom: 0;
      left: 0; right: 0;
      background: rgba(10,10,15,0.97);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-top: 1px solid var(--border);
      padding: 0.5rem 1rem calc(0.5rem + env(safe-area-inset-bottom, 0px));
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      z-index: 50;
    }
    footer a {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.2rem;
      color: var(--muted);
      text-decoration: none;
      font-size: 0.7rem;
      padding: 0.25rem 0.75rem;
      border-radius: 10px;
      transition: color 0.2s;
    }
    footer a:hover { color: var(--text); }
    footer a em {
      display: block;
      font-size: 1.25rem;
      font-style: normal;
      line-height: 1;
    }
    /* Compatibilidad con <span> legado */
    footer span {
      font-size: 0.7rem;
      color: var(--muted);
      text-align: center;
    }
    footer span em { display: block; font-size: 1.2rem; font-style: normal; }

    /* ONBOARDING */
    .ob-dot { width:8px;height:8px;border-radius:50%;background:#1e1e30;transition:background .2s; }
    .ob-dot.active { background:#7c3aed; }

    /* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    /* BASE mÃ³vil-first: fixes universales para pantallas â‰¤ 520px */
    @media (max-width: 520px) {
      body { -webkit-tap-highlight-color: transparent; }

      /* Header */
      header { padding: 1.25rem 0.875rem 0.5rem; }
      .logo-icon { font-size: 2rem; margin-bottom: 0.25rem; }
      header h1 { font-size: 1.6rem; }
      header p { font-size: 0.82rem; }

      /* Layout */
      .main { padding: 0 0.75rem calc(4.5rem + env(safe-area-inset-bottom, 0px)); }
      .card { padding: 1rem; border-radius: 14px; margin-bottom: 0.75rem; }

      /* Profile row â†’ apilado verticalmente */
      .profile-row {
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
      }
      .profile-row input {
        width: 100%;
        font-size: 1rem;
        padding: 0.75rem 0.875rem;
        min-height: 48px;
      }
      #dogSelector {
        width: 100%;
        min-height: 48px;
        font-size: 1rem;
        padding: 0.75rem 0.875rem;
        margin-top: 0.5rem;
      }

      /* Auth banner */
      #authBanner {
        font-size: 0.78rem !important;
        padding: 0.5rem 0.875rem !important;
        gap: 0.5rem !important;
      }

      /* Waveform */
      #waveform { height: 56px; }

      /* BotÃ³n grabar */
      .record-btn { width: 84px; height: 84px; font-size: 2rem; }

      /* BotÃ³n analizar */
      .analyze-btn {
        padding: 0.9rem 1rem;
        font-size: 1rem;
        min-height: 52px;
        border-radius: 14px;
      }

      /* Resultado */
      .emotion-badge { font-size: 0.78rem; }
      .message-bubble { padding: 1rem; }
      .message-bubble p { font-size: 0.95rem; line-height: 1.5; }

      /* Meta grid â†’ 1 columna */
      .meta-grid { grid-template-columns: 1fr; gap: 0.5rem; }
      .meta-item { padding: 0.65rem 0.875rem; }
      .meta-item .label { font-size: 0.67rem; }
      .meta-item .value { font-size: 0.9rem; }

      /* RecomendaciÃ³n */
      .recommendation { font-size: 0.82rem; padding: 0.625rem 0.875rem; }

      /* BotÃ³n "intentar de nuevo" */
      .try-again-btn { font-size: 0.85rem; padding: 0.7rem; }

      /* Historial */
      .history-item { gap: 0.5rem; padding: 0.5rem 0; }
      .history-emoji { font-size: 1.1rem; }
      .history-info .emotion { font-size: 0.82rem; }
      .history-info .msg {
        font-size: 0.75rem;
        max-width: calc(100vw - 130px);
      }

      /* Footer */
      footer {
        gap: 0;
        justify-content: space-around;
        padding: 0.5rem 0 calc(0.5rem + env(safe-area-inset-bottom, 0px));
      }
      footer a { flex: 1; text-align: center; }
      footer span { font-size: 0.62rem; }
      footer span em { font-size: 1.1rem; }
    }

    /* iPhone SE (375px) y pantallas muy estrechas */
    @media (max-width: 380px) {
      header { padding: 1rem 0.75rem 0.4rem; }
      .main { padding: 0 0.625rem calc(4.5rem + env(safe-area-inset-bottom, 0px)); }
      .card { padding: 0.875rem; }
      .record-btn { width: 76px; height: 76px; font-size: 1.8rem; }
    }

    /* Tablet / Desktop â‰¥ 560px */
    @media (min-width: 560px) {
      header { max-width: 520px; }
      .main { max-width: 520px; }
    }
    @media (min-width: 680px) {
      header { max-width: 580px; padding: 2.5rem 2rem 1rem; }
      header h1 { font-size: 2.2rem; }
      .main { max-width: 580px; padding: 0 1.5rem 5rem; }
      .record-btn { width: 96px; height: 96px; font-size: 2.2rem; }
      footer { gap: 3rem; justify-content: center; }
      footer a { flex: none; }
    }

    /* Sin hover en pantallas tÃ¡ctiles */
    @media (hover: none) {
      .record-btn:hover { transform: none; box-shadow: none; }
      .analyze-btn:hover { opacity: 1; transform: none; }
      .try-again-btn:hover { border-color: var(--border); color: var(--muted); }
    }

    /* Safe area iPhone X+ */
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      footer { padding-bottom: calc(0.5rem + env(safe-area-inset-bottom)); }
    }
  </style>
</head>
<body>

<!-- ONBOARDING (primera visita) -->
<div id="onboarding" style="display:none;position:fixed;inset:0;z-index:500;background:rgba(0,0,0,0.85);backdrop-filter:blur(6px);padding:1.5rem;align-items:center;justify-content:center">
  <div style="background:#111118;border:1px solid #2a1a50;border-radius:1.5rem;padding:2rem;max-width:380px;width:100%;text-align:center">
    <div id="onboardStep" style="min-height:180px"></div>
    <div style="display:flex;gap:0.5rem;justify-content:center;margin:1.25rem 0">
      <div class="ob-dot active" id="dot0"></div>
      <div class="ob-dot" id="dot1"></div>
      <div class="ob-dot" id="dot2"></div>
    </div>
    <button id="obBtn" onclick="nextOnboard()" style="width:100%;background:#7c3aed;color:white;border:none;border-radius:12px;padding:0.875rem;font-size:1rem;font-weight:700;cursor:pointer">Siguiente â†’</button>
    <button onclick="skipOnboard()" style="background:none;border:none;color:#64748b;font-size:0.8rem;cursor:pointer;margin-top:0.75rem;display:block;width:100%">Saltar</button>
  </div>
</div>

<header>
  <div class="logo-icon">ğŸ¾</div>
  <h1>Guau<span>AI</span></h1>
  <p>Entiende lo que dice tu perro con IA</p>
</header>
<div id="authBanner" style="background:#111118;border-bottom:1px solid #1e1e30;padding:.6rem 1rem;display:flex;align-items:center;justify-content:space-between;font-size:.85rem;color:#64748b;gap:.75rem;flex-wrap:wrap"></div>

<main class="main">

  <!-- PERFIL DEL PERRO -->
  <div class="card">
    <div class="profile-row">
      <input type="text" id="dogName" placeholder="ğŸ¶ Nombre del perro" maxlength="30"/>
      <input type="text" id="dogBreed" placeholder="Raza (opcional)" maxlength="50" list="breedList" autocomplete="off"/>
      <datalist id="breedList">
        <option value="Labrador Retriever"/><option value="Pastor AlemÃ¡n"/><option value="Golden Retriever"/>
        <option value="Bulldog FrancÃ©s"/><option value="Bulldog InglÃ©s"/><option value="Poodle"/>
        <option value="Beagle"/><option value="Yorkshire Terrier"/><option value="Chihuahua"/>
        <option value="Dachshund"/><option value="Husky Siberiano"/><option value="Shih Tzu"/>
        <option value="Boxer"/><option value="Schnauzer"/><option value="Cocker Spaniel"/>
        <option value="Border Collie"/><option value="Australian Shepherd"/><option value="Rottweiler"/>
        <option value="Dobermann"/><option value="DÃ¡lmata"/><option value="Weimaraner"/>
        <option value="Jack Russell Terrier"/><option value="West Highland Terrier"/><option value="Pomerania"/>
        <option value="MaltÃ©s"/><option value="BichÃ³n FrisÃ©"/><option value="Cavalier King Charles"/>
        <option value="Shar Pei"/><option value="Chow Chow"/><option value="Akita Inu"/>
        <option value="Shiba Inu"/><option value="Samoyedo"/><option value="Malamute de Alaska"/>
        <option value="Gran DanÃ©s"/><option value="San Bernardo"/><option value="MastÃ­n"/>
        <option value="Galgo"/><option value="Whippet"/><option value="Basenji"/>
        <option value="Vizsla"/><option value="Setter IrlandÃ©s"/><option value="Braco AlemÃ¡n"/>
      </datalist>
    </div>
    <select id="dogSelector" style="display:none;width:100%;margin-top:.5rem;padding:.6rem .875rem;background:#1a1a2e;border:1px solid #222230;border-radius:10px;color:#f0f0f5;font-size:.875rem"></select>

    <!-- RECORDER -->
    <div class="recorder">
      <canvas id="waveform"></canvas>
      <div class="timer" id="timer">00:00</div>
      <button class="record-btn" id="recordBtn" title="Grabar">ğŸ™ï¸</button>
      <p class="status-label" id="statusLabel">Pulsa para grabar el sonido de tu perro</p>
    </div>
  </div>

  <!-- BOTÃ“N ANALIZAR -->
  <button class="analyze-btn" id="analyzeBtn">ğŸ” Analizar lo que dice</button>

  <!-- LOADER -->
  <div class="loader card" id="loader">
    <div class="spinner"></div>
    <p>Analizando vocalizaciones...</p>
  </div>

  <!-- ERROR -->
  <div class="error-msg card" id="errorMsg"></div>

  <!-- RESULTADO -->
  <div class="result card" id="result"></div>

  <!-- HISTORIAL -->
  <div class="card" id="historyCard" style="display:none">
    <div class="history-title">Historial de la sesiÃ³n</div>
    <div id="historyList"></div>
  </div>

</main>

<footer>
  <a href="/"><em>ğŸ¤</em>Analizar</a>
  <a href="/dashboard"><em>ğŸ“Š</em>Dashboard</a>
  <a href="https://github.com/JoseALemos/guauai" target="_blank"><em>â­</em>GitHub</a>
</footer>

<script>
const API_BASE = '/api';
const LANG = navigator.language?.slice(0,2) || 'es'; // auto-detect: es, en, de...
const recordBtn = document.getElementById('recordBtn');
const analyzeBtn = document.getElementById('analyzeBtn');
const timerEl = document.getElementById('timer');
const statusLabel = document.getElementById('statusLabel');
const loaderEl = document.getElementById('loader');
const resultEl = document.getElementById('result');
const errorEl = document.getElementById('errorMsg');
const historyCard = document.getElementById('historyCard');
const historyList = document.getElementById('historyList');

let mediaRecorder = null;
let audioChunks = [];
let recordedBlob = null;
let timerInterval = null;
let seconds = 0;
let animationId = null;
let analyserNode = null;
let history = [];

// â”€â”€ PERFILES PERSISTENTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STORAGE_KEY = 'guauai_profile';
function saveProfile() {
  const name = document.getElementById('dogName').value;
  const breed = document.getElementById('dogBreed').value;
  if (name) localStorage.setItem(STORAGE_KEY, JSON.stringify({ name, breed }));
}
function loadProfile() {
  try {
    const p = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    if (p.name) document.getElementById('dogName').value = p.name;
    if (p.breed) document.getElementById('dogBreed').value = p.breed;
  } catch {}
}
document.getElementById('dogName').addEventListener('change', saveProfile);
document.getElementById('dogBreed').addEventListener('change', saveProfile);
loadProfile();

// Waveform
const canvas = document.getElementById('waveform');
const ctx = canvas.getContext('2d');

function resizeCanvas() {
  canvas.width = canvas.offsetWidth * window.devicePixelRatio;
  canvas.height = canvas.offsetHeight * window.devicePixelRatio;
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

function drawIdle() {
  const w = canvas.offsetWidth, h = canvas.offsetHeight;
  ctx.clearRect(0, 0, w, h);
  ctx.strokeStyle = 'rgba(124,58,237,0.2)';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.moveTo(0, h/2);
  ctx.lineTo(w, h/2);
  ctx.stroke();
}
drawIdle();

function drawWaveform(dataArray) {
  const w = canvas.offsetWidth, h = canvas.offsetHeight;
  ctx.clearRect(0, 0, w, h);
  ctx.strokeStyle = 'rgba(168,85,247,0.8)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  const sliceWidth = w / dataArray.length;
  let x = 0;
  for (let i = 0; i < dataArray.length; i++) {
    const v = dataArray[i] / 128.0;
    const y = (v * h) / 2;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
    x += sliceWidth;
  }
  ctx.lineTo(w, h/2);
  ctx.stroke();
}

function formatTime(s) {
  return String(Math.floor(s/60)).padStart(2,'0') + ':' + String(s%60).padStart(2,'0');
}

// â”€â”€ GRABAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
recordBtn.addEventListener('click', async () => {
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    stopRecording();
  } else {
    await startRecording();
  }
});

async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    // Waveform analyser
    const audioCtx = new AudioContext();
    const source = audioCtx.createMediaStreamSource(stream);
    analyserNode = audioCtx.createAnalyser();
    analyserNode.fftSize = 512;
    source.connect(analyserNode);
    const dataArray = new Uint8Array(analyserNode.frequencyBinCount);

    function drawLoop() {
      analyserNode.getByteTimeDomainData(dataArray);
      drawWaveform(dataArray);
      animationId = requestAnimationFrame(drawLoop);
    }
    drawLoop();

    audioChunks = [];
    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
    mediaRecorder.onstop = () => {
      recordedBlob = new Blob(audioChunks, { type: 'audio/webm' });
      stream.getTracks().forEach(t => t.stop());
      cancelAnimationFrame(animationId);
      drawIdle();
    };
    mediaRecorder.start(100);

    // UI
    recordBtn.textContent = 'â¹ï¸';
    recordBtn.classList.add('recording');
    statusLabel.textContent = 'Grabando... pulsa para detener';
    analyzeBtn.classList.remove('visible');
    resultEl.classList.remove('visible');
    errorEl.classList.remove('visible');
    seconds = 0;
    timerEl.textContent = '00:00';
    timerEl.classList.add('recording');
    timerInterval = setInterval(() => {
      seconds++;
      timerEl.textContent = formatTime(seconds);
      if (seconds >= 30) stopRecording(); // mÃ¡x 30 seg
    }, 1000);

  } catch (err) {
    showError('No se pudo acceder al micrÃ³fono: ' + err.message);
  }
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
  }
  clearInterval(timerInterval);
  recordBtn.textContent = 'ğŸ™ï¸';
  recordBtn.classList.remove('recording');
  timerEl.classList.remove('recording');
  if (seconds > 0) {
    statusLabel.textContent = `Audio listo (${formatTime(seconds)}) â€” pulsa analizar`;
    analyzeBtn.classList.add('visible');
  } else {
    statusLabel.textContent = 'Pulsa para grabar el sonido de tu perro';
  }
}

// â”€â”€ ANALIZAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
analyzeBtn.addEventListener('click', async () => {
  if (!recordedBlob) return;
  analyzeBtn.disabled = true;
  loaderEl.classList.add('visible');
  resultEl.classList.remove('visible');
  errorEl.classList.remove('visible');

  try {
    const reader = new FileReader();
    reader.readAsDataURL(recordedBlob);
    reader.onloadend = async () => {
      const base64 = reader.result.split(',')[1];
      const selectedDogId = document.getElementById('dogSelector')?.value || null;
      const headers = { 'Content-Type': 'application/json' };
      if (authToken) headers['Authorization'] = `Bearer ${authToken}`;

      const res = await fetch(`${API_BASE}/audio/analyze-base64`, {
        method: 'POST',
        headers,
        body: JSON.stringify({
          audio_base64: base64,
          mime_type: 'audio/webm',
          lang: LANG,
          dog_name: document.getElementById('dogName').value || 'Mi perro',
          dog_breed: document.getElementById('dogBreed').value || null,
          dog_id: selectedDogId || undefined,
        })
      });

      loaderEl.classList.remove('visible');

      if (!res.ok) {
        const err = await res.json();
        showError(err.error || 'Error al analizar');
        return;
      }

      const data = await res.json();
      if (data.analysis?.error) {
        showError('No se detectÃ³ audio de perro. Intenta grabar mÃ¡s cerca.');
        return;
      }

      renderResult(data);
      addToHistory(data);
      analyzeBtn.classList.remove('visible');
      analyzeBtn.disabled = false;
    };
  } catch (err) {
    loaderEl.classList.remove('visible');
    analyzeBtn.disabled = false;
    showError('Error de conexiÃ³n: ' + err.message);
  }
});

// â”€â”€ RENDER RESULTADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EMOTION_EMOJI = {
  ansioso: 'ğŸ˜°', tranquilo: 'ğŸ˜Œ', excitado: 'ğŸ¤©', asustado: 'ğŸ˜¨',
  alerta: 'âš¡', juguetÃ³n: 'ğŸ¾', dolorido: 'ğŸ¤•', agresivo: 'ğŸ˜¡',
  frustrado: 'ğŸ˜¤', feliz: 'ğŸ˜„'
};

const NEED_LABEL = {
  atenciÃ³n: 'Pide atenciÃ³n', juego: 'Quiere jugar', comida: 'Tiene hambre',
  agua: 'Quiere agua', paseo: 'Quiere salir', alarma: 'EstÃ¡ alertando',
  dolor: 'Siente dolor', miedo: 'Tiene miedo', territorial: 'Marcando territorio',
  sin_necesidad_clara: 'Sin necesidad concreta'
};

function renderResult(data) {
  const a = data.analysis;
  const emoji = EMOTION_EMOJI[a.estado_emocional] || 'ğŸ¶';
  const conf = Math.round((a.confianza || 0) * 100);

  resultEl.innerHTML = `
    <div class="emotion-badge">${emoji} ${a.estado_emocional?.toUpperCase() || 'DESCONOCIDO'}</div>

    <div class="message-bubble">
      <span class="dog-icon">${emoji}</span>
      <p><span class="quote-mark">"</span>${a.mensaje_interpretado || '...'}<span class="quote-mark">"</span></p>
    </div>

    <div class="meta-grid">
      <div class="meta-item">
        <div class="label">Necesidad</div>
        <div class="value">${NEED_LABEL[a.necesidad] || a.necesidad || 'â€”'}</div>
      </div>
      <div class="meta-item">
        <div class="label">VocalizaciÃ³n</div>
        <div class="value">${a.tipo_vocalizacion || 'â€”'}</div>
      </div>
      <div class="meta-item">
        <div class="label">Intensidad</div>
        <div class="value">${a.intensidad?.toUpperCase() || 'â€”'}</div>
      </div>
      <div class="meta-item">
        <div class="label">Confianza IA</div>
        <div class="value">${conf}%</div>
        <div class="confidence-bar">
          <div class="confidence-fill" style="width:${conf}%"></div>
        </div>
      </div>
    </div>

    ${a.recomendacion_dueno ? `
    <div class="recommendation">
      <span>ğŸ’¡</span>
      <span>${a.recomendacion_dueno}</span>
    </div>` : ''}

    <button class="try-again-btn" onclick="resetRecorder()">ğŸ”„ Grabar de nuevo</button>
  `;
  resultEl.classList.add('visible');
}

function addToHistory(data) {
  const a = data.analysis;
  const entry = {
    emotion: a.estado_emocional,
    need: a.necesidad,
    intensity: a.intensidad,
    conf: Math.round((a.confianza || 0) * 100),
    msg: a.mensaje_interpretado,
    time: new Date().toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit'})
  };
  history.unshift(entry);
  if (history.length > 20) history.pop();
  renderHistory();
}

function renderHistory() {
  historyCard.style.display = 'block';
  historyList.innerHTML = history.map(h => `
    <div class="history-item">
      <span class="history-emoji">${EMOTION_EMOJI[h.emotion] || 'ğŸ¶'}</span>
      <div class="history-info">
        <div class="emotion">${h.emotion}${h.conf ? ` Â· ${h.conf}%` : ''}</div>
        <div class="msg">"${h.msg}"</div>
      </div>
      <div class="history-info" style="flex:0; text-align:right">
        <div class="time">${h.time}</div>
      </div>
    </div>
  `).join('') + `
    <button class="try-again-btn" onclick="exportHistory()" style="margin-top:0.75rem">
      ğŸ“¥ Exportar CSV
    </button>
  `;
}

function showError(msg) {
  errorEl.textContent = 'âš ï¸ ' + msg;
  errorEl.classList.add('visible');
  analyzeBtn.disabled = false;
}

function resetRecorder() {
  recordedBlob = null;
  seconds = 0;
  timerEl.textContent = '00:00';
  statusLabel.textContent = 'Pulsa para grabar el sonido de tu perro';
  analyzeBtn.classList.remove('visible');
  resultEl.classList.remove('visible');
  errorEl.classList.remove('visible');
  drawIdle();
}

// â”€â”€ EXPORT HISTORIAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportHistory() {
  if (!history.length) return;
  const dog = document.getElementById('dogName').value || 'MiPerro';
  const csv = ['Hora,Estado,Necesidad,Intensidad,Confianza,Mensaje']
    .concat(history.map(h => `${h.time},"${h.emotion}","${h.need||''}","${h.intensity||''}",${h.conf||''},"${h.msg}"`))
    .join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `guauai_${dog}_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}

// â”€â”€ PWA INSTALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  const btn = document.getElementById('installBtn');
  if (btn) btn.style.display = 'block';
});
window.addEventListener('appinstalled', () => {
  deferredPrompt = null;
  const btn = document.getElementById('installBtn');
  if (btn) btn.style.display = 'none';
});

// â”€â”€ SERVICE WORKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(() => {});
}

// â”€â”€ AUTH INTEGRATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const authToken = localStorage.getItem('guauai_token');
let currentUserId = null;

async function initAuthBanner() {
  const banner = document.getElementById('authBanner');
  if (!banner) return;
  if (authToken) {
    try {
      const r = await fetch(`${API_BASE}/auth/me`, { headers: { Authorization: `Bearer ${authToken}` } });
      if (r.ok) {
        const u = await r.json();
        currentUserId = u.id;
        banner.innerHTML = `<span>ğŸ‘‹ ${u.name || u.email}</span><a href="/dashboard" style="color:var(--accent2);font-weight:700;text-decoration:none">Ir al dashboard â†’</a>`;
        banner.style.background = '#0d0d1a';
        // cargar perros del usuario para el selector
        loadUserDogs();
        return;
      }
    } catch {}
  }
  banner.innerHTML = `<span>Guarda tu historial y estadÃ­sticas</span><a href="/dashboard" style="background:var(--accent);color:white;padding:.35rem .9rem;border-radius:8px;font-weight:700;text-decoration:none;font-size:.8rem">Crear cuenta gratis â†’</a>`;
}

async function loadUserDogs() {
  if (!authToken) return;
  try {
    const r = await fetch(`${API_BASE}/dogs`, { headers: { Authorization: `Bearer ${authToken}` } });
    if (!r.ok) return;
    const dogs = await r.json();
    const sel = document.getElementById('dogSelector');
    if (!sel || !dogs.length) return;
    sel.innerHTML = '<option value="">Sin perro asociado</option>' + dogs.map(d => `<option value="${d.id}" data-breed="${d.breed||''}">${d.name}${d.breed ? ' (' + d.breed + ')' : ''}</option>`).join('');
    sel.style.display = 'block';
    sel.addEventListener('change', () => {
      const opt = sel.options[sel.selectedIndex];
      if (opt.value) {
        document.getElementById('dogName').value = opt.text.split(' (')[0];
        document.getElementById('dogBreed').value = opt.dataset.breed || '';
      }
    });
  } catch {}
}

// Guardar anÃ¡lisis en DB si hay sesiÃ³n
async function saveAnalysisToDB(dogId, analysisData) {
  if (!authToken) return;
  const a = analysisData.analysis;
  const body = {
    audio_base64: '__saved__', mime_type: 'audio/mp3',
    dog_id: dogId || undefined,
    dog_name: document.getElementById('dogName')?.value,
    dog_breed: document.getElementById('dogBreed')?.value,
  };
  // El endpoint ya guarda automÃ¡ticamente si hay auth header â€” se pasa en el fetch principal
}

initAuthBanner();

// â”€â”€ ONBOARDING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const OB_STEPS = [
  { emoji:'ğŸ¤', title:'Graba a tu perro', text:'Pulsa el botÃ³n central y graba cualquier sonido â€” ladrido, gemido, gruÃ±ido. MÃ­nimo 2 segundos.' },
  { emoji:'ğŸ§ ', title:'IA en tiempo real', text:'GuauAI analiza el audio con el modelo gpt-audio de OpenAI y detecta el estado emocional, necesidad e intensidad.' },
  { emoji:'ğŸ“Š', title:'Guarda tu historial', text:'Crea una cuenta gratis para guardar todos los anÃ¡lisis, ver estadÃ­sticas de comportamiento y recibir alertas.' },
];
let obStep = 0;

function renderOnboardStep() {
  const s = OB_STEPS[obStep];
  document.getElementById('onboardStep').innerHTML = `
    <div style="font-size:3.5rem;margin-bottom:1rem">${s.emoji}</div>
    <h2 style="font-size:1.3rem;font-weight:800;margin-bottom:.75rem">${s.title}</h2>
    <p style="color:#94a3b8;font-size:.95rem;line-height:1.6">${s.text}</p>`;
  document.querySelectorAll('.ob-dot').forEach((d,i) => d.classList.toggle('active', i === obStep));
  document.getElementById('obBtn').textContent = obStep === OB_STEPS.length - 1 ? 'Â¡Empezar! ğŸ¾' : 'Siguiente â†’';
}

function nextOnboard() {
  if (obStep < OB_STEPS.length - 1) { obStep++; renderOnboardStep(); }
  else skipOnboard();
}

function skipOnboard() {
  document.getElementById('onboarding').style.display = 'none';
  localStorage.setItem('guauai_onboarded', '1');
}

if (!localStorage.getItem('guauai_onboarded')) {
  renderOnboardStep();
  document.getElementById('onboarding').style.display = 'flex';
}
</script>
</body>
</html>
