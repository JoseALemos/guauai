<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GuauAI â€” Dashboard</title>
  <meta name="theme-color" content="#7c3aed"/>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg"/>
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png"/>
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png"/>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
  <link rel="manifest" href="/manifest.json"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0a0a0f; --bg2: #111118; --bg3: #1a1a2e;
      --purple: #7c3aed; --purple2: #a855f7;
      --green: #10b981; --red: #ef4444; --yellow: #f59e0b;
      --text: #f1f5f9; --muted: #64748b; --border: #1e1e30;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg); color: var(--text); font-family: 'Inter', system-ui, sans-serif; min-height: 100vh; }

    /* â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #authScreen {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; padding: 1rem;
      background: radial-gradient(ellipse at 50% 0%, #3b0764 0%, #0a0a0f 60%);
    }
    .auth-card {
      background: var(--bg2); border: 1px solid var(--border);
      border-radius: 1.5rem; padding: 2.5rem 2rem; width: 100%; max-width: 380px;
    }
    .auth-logo { text-align: center; margin-bottom: 2rem; }
    .auth-logo h1 { font-size: 2rem; font-weight: 800; }
    .auth-logo h1 span { color: var(--purple2); }
    .auth-logo p { color: var(--muted); font-size: 0.875rem; margin-top: 0.25rem; }
    .auth-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
    .auth-tab {
      flex: 1; padding: 0.5rem; border: 1px solid var(--border); border-radius: 0.75rem;
      background: transparent; color: var(--muted); cursor: pointer; font-size: 0.875rem; transition: all 0.2s;
    }
    .auth-tab.active { background: var(--purple); border-color: var(--purple); color: white; font-weight: 600; }
    .field { margin-bottom: 1rem; }
    .field label { display: block; font-size: 0.75rem; color: var(--muted); margin-bottom: 0.4rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }
    .field input {
      width: 100%; padding: 0.75rem 1rem; background: var(--bg3); border: 1px solid var(--border);
      border-radius: 0.75rem; color: var(--text); font-size: 0.95rem; outline: none; transition: border 0.2s;
    }
    .field input:focus { border-color: var(--purple2); }
    .btn-primary {
      width: 100%; padding: 0.875rem; background: var(--purple); border: none; border-radius: 0.75rem;
      color: white; font-size: 1rem; font-weight: 700; cursor: pointer; transition: background 0.2s; margin-top: 0.5rem;
    }
    .btn-primary:hover { background: var(--purple2); }
    .auth-error { background: #3f1212; border: 1px solid var(--red); border-radius: 0.75rem; padding: 0.75rem 1rem; font-size: 0.875rem; color: #fca5a5; margin-bottom: 1rem; display: none; }

    /* â”€â”€ APP SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #app { display: none; min-height: 100vh; }
    .sidebar {
      position: fixed; top: 0; left: 0; bottom: 0; width: 240px;
      background: var(--bg2); border-right: 1px solid var(--border);
      padding: 1.5rem 1rem; display: flex; flex-direction: column; z-index: 100;
    }
    .sidebar-logo { font-size: 1.5rem; font-weight: 800; padding: 0 0.5rem; margin-bottom: 2rem; }
    .sidebar-logo span { color: var(--purple2); }
    nav a {
      display: flex; align-items: center; gap: 0.75rem; padding: 0.625rem 0.75rem;
      border-radius: 0.75rem; color: var(--muted); text-decoration: none; font-size: 0.9rem; transition: all 0.15s; margin-bottom: 0.25rem;
    }
    nav a:hover { background: var(--bg3); color: var(--text); }
    nav a.active { background: var(--purple); color: white; font-weight: 600; }
    .sidebar-footer { margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border); }
    .user-pill { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; border-radius: 0.75rem; }
    .user-avatar { width: 32px; height: 32px; background: var(--purple); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.875rem; flex-shrink: 0; }
    .user-name { font-size: 0.8rem; color: var(--muted); }
    .btn-logout { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 0.75rem; padding: 0.25rem 0.5rem; }
    .btn-logout:hover { color: var(--red); }
    .main { margin-left: 240px; padding: 2rem; min-height: 100vh; }

    /* â”€â”€ PAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .page { display: none; }
    .page.active { display: block; }
    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; }
    .page-header h2 { font-size: 1.5rem; font-weight: 700; }
    .btn-sm {
      padding: 0.5rem 1rem; background: var(--purple); border: none; border-radius: 0.75rem;
      color: white; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: background 0.2s;
    }
    .btn-sm:hover { background: var(--purple2); }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn-outline:hover { border-color: var(--purple2); color: var(--purple2); }

    /* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .card { background: var(--bg2); border: 1px solid var(--border); border-radius: 1rem; padding: 1.5rem; }
    .card-label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
    .card-value { font-size: 2rem; font-weight: 800; }
    .card-sub { font-size: 0.8rem; color: var(--muted); margin-top: 0.25rem; }

    /* â”€â”€ DOG GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dog-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1rem; }
    .dog-card {
      background: var(--bg2); border: 1px solid var(--border); border-radius: 1.25rem; padding: 1.5rem;
      cursor: pointer; transition: border-color 0.2s, transform 0.1s;
    }
    .dog-card:hover { border-color: var(--purple2); transform: translateY(-2px); }
    .dog-card-top { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
    .dog-avatar { width: 56px; height: 56px; background: linear-gradient(135deg, var(--purple), var(--purple2)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; flex-shrink: 0; }
    .dog-name { font-size: 1.1rem; font-weight: 700; }
    .dog-breed { font-size: 0.8rem; color: var(--muted); }
    .dog-stats-row { display: flex; gap: 1rem; font-size: 0.8rem; color: var(--muted); }
    .dog-stat strong { color: var(--text); }
    .add-dog-card {
      background: transparent; border: 2px dashed var(--border); border-radius: 1.25rem;
      padding: 1.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 0.5rem; cursor: pointer; color: var(--muted); font-size: 0.9rem; min-height: 140px;
      transition: border-color 0.2s, color 0.2s;
    }
    .add-dog-card:hover { border-color: var(--purple2); color: var(--purple2); }
    .add-dog-card span:first-child { font-size: 2rem; }

    /* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200;
      display: flex; align-items: center; justify-content: center; padding: 1rem; display: none;
    }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--bg2); border: 1px solid var(--border); border-radius: 1.5rem; padding: 2rem; width: 100%; max-width: 420px; }
    .modal h3 { font-size: 1.2rem; font-weight: 700; margin-bottom: 1.5rem; }
    .modal-footer { display: flex; gap: 0.75rem; margin-top: 1.5rem; }
    .modal-footer button { flex: 1; }

    /* â”€â”€ HISTORY TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .history-table { width: 100%; border-collapse: collapse; }
    .history-table th { text-align: left; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); }
    .history-table td { padding: 0.875rem 1rem; border-bottom: 1px solid var(--border); font-size: 0.875rem; }
    .history-table tr:hover td { background: var(--bg3); }
    .badge {
      display: inline-block; padding: 0.2rem 0.6rem; border-radius: 9999px; font-size: 0.7rem; font-weight: 600;
    }
    .badge-feliz, .badge-happy { background: #064e3b; color: #6ee7b7; }
    .badge-ansioso, .badge-anxious { background: #3f1812; color: #fca5a5; }
    .badge-excitado, .badge-excited { background: #3b2a00; color: #fcd34d; }
    .badge-asustado, .badge-scared { background: #1e1b4b; color: #a5b4fc; }
    .badge-alerta, .badge-alert { background: #2d1b00; color: #fed7aa; }
    .badge-default { background: var(--bg3); color: var(--muted); }

    /* â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }
    .chart-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 1rem; padding: 1.5rem; }
    .chart-card h4 { font-size: 0.875rem; font-weight: 600; color: var(--muted); margin-bottom: 1.25rem; text-transform: uppercase; letter-spacing: 0.05em; }

    /* â”€â”€ DOG DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .back-btn { display: inline-flex; align-items: center; gap: 0.5rem; color: var(--muted); font-size: 0.875rem; cursor: pointer; margin-bottom: 1.5rem; }
    .back-btn:hover { color: var(--text); }

    /* â”€â”€ EMPTY STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty { text-align: center; padding: 4rem 1rem; color: var(--muted); }
    .empty span { font-size: 3rem; display: block; margin-bottom: 1rem; }

    /* â”€â”€ SHARE TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .toast {
      position: fixed; bottom: 1.5rem; right: 1.5rem; background: var(--green);
      color: white; padding: 0.75rem 1.25rem; border-radius: 0.75rem; font-size: 0.875rem;
      font-weight: 600; z-index: 999; opacity: 0; transform: translateY(1rem);
      transition: all 0.3s; pointer-events: none;
    }
    .toast.show { opacity: 1; transform: translateY(0); }

    /* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 900px) {
      .charts-grid { grid-template-columns: 1fr; }
      .cards { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.25s cubic-bezier(.4,0,.2,1);
        z-index: 300; width: 260px;
        box-shadow: 4px 0 32px rgba(0,0,0,0.6);
      }
      .sidebar.open { transform: translateX(0); }
      .sidebar-overlay {
        display: none; position: fixed; inset: 0;
        background: rgba(0,0,0,0.55); z-index: 299;
        backdrop-filter: blur(2px);
      }
      .sidebar-overlay.open { display: block; }
      .main { margin-left: 0; padding: 1rem; padding-top: 4.5rem; }
      .topbar {
        display: flex; position: fixed; top: 0; left: 0; right: 0; z-index: 200;
        background: var(--bg2); border-bottom: 1px solid var(--border);
        padding: 0.875rem 1rem; align-items: center; gap: 0.75rem;
      }
      .topbar-title { font-size: 1.1rem; font-weight: 800; flex: 1; }
      .topbar-title span { color: var(--purple2); }
      .menu-btn {
        background: none; border: 1px solid var(--border);
        color: var(--text); font-size: 1.1rem; cursor: pointer;
        padding: 0.4rem 0.6rem; border-radius: 8px; line-height: 1;
      }
      .dog-grid { grid-template-columns: 1fr; }
      .modal { padding: 1.25rem; border-radius: 1rem; }
      .page-header { flex-wrap: wrap; gap: 0.5rem; }
      .page-header h2 { font-size: 1.2rem; }
      .history-table th, .history-table td { padding: 0.6rem 0.5rem; font-size: 0.8rem; }
    }
    @media (max-width: 480px) {
      .cards { grid-template-columns: 1fr 1fr; gap: 0.625rem; }
      .card { padding: 1.1rem; border-radius: 0.875rem; }
      .card-value { font-size: 1.5rem; }
      .main { padding: 0.75rem; padding-top: 4.5rem; }
      .col-hide { display: none; }
    }
    @supports (padding-top: env(safe-area-inset-top)) {
      .topbar { padding-top: max(0.875rem, env(safe-area-inset-top)); }
    }
    @media (hover: none) {
      .dog-card:hover { transform: none; border-color: var(--border); }
      .btn-sm:hover { background: var(--purple); }
    }
    /* â”€â”€ RECORDER (Analizador integrado) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .rec-wrap { max-width: 480px; }
    #recWaveform { width:100%; height:56px; border-radius:10px; background:rgba(124,58,237,.07); border:1px solid var(--border); display:block; }
    .rec-controls { display:flex; flex-direction:column; align-items:center; gap:.75rem; margin-top:.75rem; }
    .rec-btn {
      width:72px; height:72px; border-radius:50%; border:none;
      background:linear-gradient(135deg,var(--purple),var(--purple2));
      color:#fff; font-size:1.6rem; cursor:pointer;
      transition:transform .15s; box-shadow:0 0 0 0 rgba(124,58,237,.4);
    }
    .rec-btn:hover { transform:scale(1.06); }
    .rec-btn.recording { background:linear-gradient(135deg,#c81e1e,#ef4444); animation:rec-pulse 1.5s ease-out infinite; }
    @keyframes rec-pulse { 0%{box-shadow:0 0 0 0 rgba(239,68,68,.5)} 70%{box-shadow:0 0 0 18px rgba(239,68,68,0)} 100%{box-shadow:0 0 0 0 rgba(239,68,68,0)} }
    .rec-timer { font-size:.95rem; font-weight:700; color:var(--muted); letter-spacing:2px; font-variant-numeric:tabular-nums; }
    .rec-timer.recording { color:#ef4444; }
    .rec-status { font-size:.8rem; color:var(--muted); text-align:center; }
    .rec-analyze-btn {
      width:100%; background:linear-gradient(135deg,var(--purple),var(--purple2));
      color:#fff; border:none; border-radius:100px; padding:.875rem; font-weight:800;
      font-size:.95rem; cursor:pointer; display:none; transition:opacity .2s;
    }
    .rec-analyze-btn.visible { display:block; }
    .rec-analyze-btn:disabled { opacity:.5; cursor:not-allowed; }
    .rec-loader { display:none; align-items:center; justify-content:center; gap:.75rem; padding:.75rem 0; }
    .rec-loader.visible { display:flex; }
    .rec-spinner { width:28px; height:28px; border:2px solid var(--border); border-top-color:var(--purple2); border-radius:50%; animation:spin .8s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .rec-error { background:rgba(239,68,68,.08); border:1px solid rgba(239,68,68,.2); border-radius:10px; padding:.875rem; color:#fca5a5; font-size:.875rem; display:none; margin-top:.5rem; }
    .rec-error.visible { display:block; }
    /* Result */
    .rec-result { display:none; }
    .rec-result.visible { display:block; }
    .emo-badge { display:inline-flex; align-items:center; gap:.4rem; background:rgba(124,58,237,.15); border:1px solid rgba(124,58,237,.3); border-radius:100px; padding:.35rem .9rem; font-weight:700; font-size:.8rem; color:var(--purple2); margin-bottom:.875rem; text-transform:uppercase; }
    .msg-bubble { background:linear-gradient(135deg,rgba(124,58,237,.1),rgba(168,85,247,.08)); border:1px solid rgba(124,58,237,.2); border-radius:14px 14px 14px 4px; padding:1rem; margin-bottom:.875rem; }
    .msg-bubble p { font-size:1rem; font-weight:600; line-height:1.45; }
    .rec-meta { display:grid; grid-template-columns:1fr 1fr; gap:.6rem; margin-bottom:.875rem; }
    .rec-meta-item { background:rgba(255,255,255,.03); border:1px solid var(--border); border-radius:9px; padding:.6rem .875rem; }
    .rec-meta-item .lbl { font-size:.67rem; color:var(--muted); text-transform:uppercase; letter-spacing:.05em; margin-bottom:.25rem; }
    .rec-meta-item .val { font-size:.875rem; font-weight:700; }
    .conf-bar { width:100%; height:5px; background:var(--border); border-radius:100px; overflow:hidden; margin-top:.35rem; }
    .conf-fill { height:100%; background:linear-gradient(90deg,var(--purple),var(--purple2)); border-radius:100px; transition:width 1s ease; }
    .rec-reco { background:rgba(34,197,94,.08); border:1px solid rgba(34,197,94,.2); border-radius:9px; padding:.7rem .875rem; font-size:.82rem; color:#86efac; display:flex; gap:.5rem; margin-bottom:.875rem; }
    .try-btn { width:100%; background:transparent; border:1px solid var(--border); border-radius:100px; padding:.7rem; color:var(--muted); font-weight:600; font-size:.875rem; cursor:pointer; transition:border-color .2s,color .2s; }
    .try-btn:hover { border-color:var(--purple); color:var(--purple2); }
    @media (max-width:480px) { .rec-meta { grid-template-columns:1fr; } }
  
  /* PWA install prompt */
  #pwaPrompt {
    display: none; position: fixed; bottom: 1.25rem; left: 50%; transform: translateX(-50%);
    background: #1e1e30; border: 1px solid #7c3aed; border-radius: 1rem;
    padding: .875rem 1.5rem; box-shadow: 0 8px 32px rgba(124,58,237,.35);
    z-index: 9999; align-items: center; gap: 1rem; max-width: 360px; width: calc(100% - 2rem);
  }
  #pwaPrompt .pwa-text { font-size: .875rem; color: #e2e8f0; flex: 1; }
  #pwaPrompt .pwa-text strong { color: #a855f7; display: block; font-size: .9rem; }
  #pwaPrompt .pwa-install { background: #7c3aed; color: #fff; border: none; border-radius: .625rem;
    padding: .5rem 1rem; font-weight: 700; font-size: .85rem; cursor: pointer; white-space: nowrap; }
  #pwaPrompt .pwa-dismiss { background: none; border: none; color: #64748b; cursor: pointer; font-size: 1.1rem; padding: .25rem; }
</style>
</head>
<body>

<!-- â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="authScreen">
  <div class="auth-card">
    <div class="auth-logo">
      <img src="/icon-192.png" alt="GuauAI" style="width:72px;height:72px;border-radius:20px;margin-bottom:.75rem"/>
      <h1>Guau<span>AI</span></h1>
      <p data-i18n="d_tagline">Habla con tu perro</p>
    </div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchTab('login')" data-i18n="d_login">Entrar</button>
      <button class="auth-tab" onclick="switchTab('register')" data-i18n="d_register">Registrarse</button>
    </div>
    <div id="authError" class="auth-error"></div>
    <div id="formLogin">
      <div class="field"><label data-i18n="d_email">Email</label><input type="email" id="loginEmail" placeholder="tu@email.com"/></div>
      <div class="field"><label data-i18n="d_pass">ContraseÃ±a</label><input type="password" id="loginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/></div>
      <button class="btn-primary" onclick="login()" data-i18n="d_login_btn">Entrar â†’</button>
    </div>
    <div id="formRegister" style="display:none">
      <div class="field"><label data-i18n="d_name">Nombre</label><input type="text" id="regName" placeholder="Tu nombre"/></div>
      <div class="field"><label data-i18n="d_email">Email</label><input type="email" id="regEmail" placeholder="tu@email.com"/></div>
      <div class="field"><label data-i18n="d_pass">ContraseÃ±a</label><input type="password" id="regPass" placeholder="MÃ­nimo 6 caracteres"/></div>
      <button class="btn-primary" onclick="register()" data-i18n="d_reg_btn">Crear cuenta â†’</button>
    </div>
  </div>
</div>

<!-- â”€â”€ APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<!-- Topbar mÃ³vil (visible solo en mÃ³vil via CSS) -->
<div class="topbar" style="display:none" id="topbar">
  <button class="menu-btn" onclick="toggleSidebar()" aria-label="MenÃº">â˜°</button>
  <div class="topbar-title" style="display:flex;align-items:center;gap:.4rem"><img src="/icon-192.png" alt="" style="width:22px;height:22px;border-radius:6px"/>Guau<span>AI</span></div>
  <div id="topbarUser" style="font-size:.75rem;color:var(--muted)"></div>
</div>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<div id="app">
  <div class="sidebar" id="sidebar">
    <div class="sidebar-logo" style="display:flex;align-items:center;gap:.6rem"><img src="/icon-192.png" alt="" style="width:32px;height:32px;border-radius:8px"/><h1>Guau<span>AI</span></h1></div>
    <nav>
      <a href="#" class="active" data-page="overview" onclick="navigate('overview',this)">ğŸ“Š <span data-i18n="d_nav_overview">Resumen</span></a>
      <a href="#" data-page="dogs" onclick="navigate('dogs',this)">ğŸ¶ <span data-i18n="d_nav_dogs">Mis Perros</span></a>
      <a href="#" data-page="analyzer" onclick="navigate('analyzer',this)">ğŸ¤ <span data-i18n="d_nav_analyze">Analizar</span></a>
      <a href="#" data-page="history" onclick="navigate('history',this)">ğŸ“‹ <span data-i18n="d_nav_history">Historial</span></a>
      <a href="#" data-page="alerts" onclick="navigate('alerts',this)">ğŸ”” <span data-i18n="d_nav_alerts">Alertas</span></a>
    </nav>
    <div class="sidebar-footer">
      <div class="lang-switcher" style="display:flex;gap:.35rem;margin-bottom:.75rem">
        <button onclick="setLang('es')" id="langEs" style="background:none;border:1px solid var(--border);border-radius:.5rem;padding:.3rem .55rem;font-size:.85rem;cursor:pointer;opacity:.5">ğŸ‡ªğŸ‡¸</button>
        <button onclick="setLang('en')" id="langEn" style="background:none;border:1px solid var(--border);border-radius:.5rem;padding:.3rem .55rem;font-size:.85rem;cursor:pointer;opacity:.5">ğŸ‡¬ğŸ‡§</button>
        <button onclick="setLang('pt')" id="langPt" style="background:none;border:1px solid var(--border);border-radius:.5rem;padding:.3rem .55rem;font-size:.85rem;cursor:pointer;opacity:.5">ğŸ‡µğŸ‡¹</button>
      </div>
      <div class="user-pill">
        <div class="user-avatar" id="userAvatar">?</div>
        <div class="user-name" id="userName"></div>
      </div>
      <button class="btn-logout" onclick="logout()" data-i18n="d_logout">Cerrar sesiÃ³n</button>
    </div>
  </div>

  <main class="main">
    <!-- OVERVIEW -->
    <div class="page active" id="page-overview">
      <div class="page-header">
        <h2 data-i18n="d_nav_overview">Resumen</h2>
        <button class="btn-sm btn-outline" onclick="shareWithVet()" title="Generar enlace para veterinario o entrenador">ğŸ©º <span data-i18n="d_share_vet">Compartir con vet</span></button>
      </div>
      <div class="cards">
        <div class="card"><div class="card-label" data-i18n="d_stat_dogs">Perros</div><div class="card-value" id="totalDogs">â€”</div></div>
        <div class="card"><div class="card-label" data-i18n="d_stat_analyses">AnÃ¡lisis totales</div><div class="card-value" id="totalAnalyses">â€”</div></div>
        <div class="card"><div class="card-label" data-i18n="d_stat_emotion">EmociÃ³n frecuente</div><div class="card-value" id="topEmotion" style="font-size:1.25rem">â€”</div></div>
        <div class="card"><div class="card-label" data-i18n="d_stat_last">Ãšltimo anÃ¡lisis</div><div class="card-value" id="lastAnalysis" style="font-size:1rem">â€”</div></div>
      </div>
      <div class="charts-grid">
        <div class="chart-card"><h4 data-i18n="d_chart_emotions">Emociones (30 dÃ­as)</h4><div style="position:relative;height:200px"><canvas id="chartEmotions"></canvas></div></div>
        <div class="chart-card"><h4 data-i18n="d_chart_activity">Actividad diaria</h4><div style="position:relative;height:200px"><canvas id="chartTimeline"></canvas></div></div>
      </div>
      <div id="overviewDogList"></div>
    </div>

    <!-- DOGS -->
    <div class="page" id="page-dogs">
      <div class="page-header">
        <h2 data-i18n="d_nav_dogs">Mis Perros</h2>
        <button class="btn-sm" onclick="openAddDog()" data-i18n="d_add_dog">+ AÃ±adir perro</button>
      </div>
      <div class="dog-grid" id="dogGrid">
        <div class="add-dog-card" onclick="openAddDog()"><span>ğŸ¾</span><span data-i18n="d_add_dog_card">AÃ±adir perro</span></div>
      </div>
    </div>

    <!-- DOG DETAIL (pseudo-page dentro de dogs) -->
    <div class="page" id="page-dogdetail">
      <div class="back-btn" onclick="navigate('dogs',null)" data-i18n="d_back_dogs">â† Volver a Mis Perros</div>
      <div id="dogDetailHeader"></div>
      <div class="charts-grid" id="dogDetailCharts"></div>
      <div class="card" style="overflow:auto">
        <table class="history-table" id="dogDetailTable">
          <thead><tr><th>Hora</th><th>EmociÃ³n</th><th class="col-hide">Necesidad</th><th class="col-hide">Intensidad</th><th>Confianza</th><th>Mensaje</th><th></th></tr></thead>
          <tbody id="dogDetailBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ANALYZER -->
    <div class="page" id="page-analyzer">
      <div class="page-header"><h2 data-i18n="d_nav_analyze_title">Analizar Sonido</h2></div>
      <div class="rec-wrap">
        <!-- Selector de perro -->
        <div class="card" style="margin-bottom:1rem">
          <div class="field"><label>Perro</label>
            <select id="analyzerDog" style="width:100%;padding:.75rem 1rem;background:var(--bg3);border:1px solid var(--border);border-radius:.75rem;color:var(--text);font-size:.95rem;outline:none">
              <option value="" data-i18n="d_no_dog">Sin asociar</option>
            </select>
          </div>
        </div>

        <!-- Recorder -->
        <div class="card" style="margin-bottom:1rem">
          <canvas id="recWaveform"></canvas>
          <div class="rec-controls">
            <div class="rec-timer" id="recTimer">00:00</div>
            <button class="rec-btn" id="recBtn" title="Grabar">ğŸ™ï¸</button>
            <p class="rec-status" id="recStatus" data-i18n="d_rec_idle">Pulsa para grabar el sonido de tu perro</p>
          </div>
        </div>

        <button class="rec-analyze-btn" id="recAnalyzeBtn" data-i18n="d_rec_analyze">ğŸ” Analizar lo que dice</button>

        <!-- Loader -->
        <div class="rec-loader card" id="recLoader" style="margin-top:.75rem">
          <div class="rec-spinner"></div>
          <span style="color:var(--muted);font-size:.85rem" data-i18n="d_rec_loading">Analizando vocalizaciones...</span>
        </div>

        <!-- Error -->
        <div class="rec-error" id="recError"></div>

        <!-- Resultado -->
        <div class="card rec-result" id="recResult" style="margin-top:.75rem"></div>
      </div>
    </div>

    <!-- HISTORY -->
    <div class="page" id="page-history">
      <div class="page-header">
        <h2 data-i18n="d_nav_history_title">Historial completo</h2>
        <button class="btn-sm btn-outline" onclick="exportAll()" data-i18n="d_export">ğŸ“¥ Exportar CSV</button>
      </div>
      <div class="card" style="overflow:auto">
        <table class="history-table" id="historyTable">
          <thead><tr><th>Fecha</th><th class="col-hide">Perro</th><th>EmociÃ³n</th><th class="col-hide">Necesidad</th><th class="col-hide">Intensidad</th><th>Conf.</th><th>Mensaje</th><th></th></tr></thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>
    <!-- ALERTS -->
    <div class="page" id="page-alerts">
      <div class="page-header"><h2 data-i18n="d_nav_alerts_title">ğŸ”” Alertas de Comportamiento</h2></div>
      <div id="alertsList">
        <div class="empty"><span>ğŸ””</span><p style="color:var(--muted)">Cargando alertas...</p></div>
      </div>
    </div>
  </main>
</div>

<!-- â”€â”€ MODAL: ADD/EDIT DOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="dogModal">
  <div class="modal">
    <h3 id="dogModalTitle">AÃ±adir perro</h3>
    <input type="hidden" id="dogModalId"/>
    <!-- Foto -->
    <div class="field" style="text-align:center">
      <div id="dogPhotoPreview" style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#7c3aed,#a855f7);display:flex;align-items:center;justify-content:center;font-size:2rem;margin:0 auto .75rem;overflow:hidden;cursor:pointer" onclick="document.getElementById('dogPhotoInput').click()">ğŸ¶</div>
      <input type="file" id="dogPhotoInput" accept="image/*" style="display:none" onchange="handlePhotoUpload(event)"/>
      <div style="font-size:.72rem;color:var(--muted)">Pulsa la foto para cambiarla</div>
    </div>
    <input type="hidden" id="dogModalPhoto"/>
    <div class="field"><label>Nombre *</label><input type="text" id="dogModalName" placeholder="Rex"/></div>
    <div class="field"><label>Raza</label><input type="text" id="dogModalBreed" placeholder="Labrador, Bulldog..."/></div>
    <div class="field"><label>Fecha de nacimiento</label><input type="date" id="dogModalBirth"/></div>
    <div class="field"><label>Peso (kg)</label><input type="number" id="dogModalWeight" placeholder="12.5" step="0.1"/></div>
    <div class="field"><label>Notas</label><input type="text" id="dogModalNotes" placeholder="Alergias, medicaciÃ³n..."/></div>
    <div class="modal-footer">
      <button class="btn-sm btn-outline" onclick="closeDogModal()">Cancelar</button>
      <button class="btn-sm" onclick="saveDog()">Guardar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API = '/api';
let token = localStorage.getItem('guauai_token');
let currentUser = null;
let dogs = [];
let emotionChart = null;
let timelineChart = null;
const EMOTION_EMOJI = { feliz:'ğŸ˜„', happy:'ğŸ˜„', ansioso:'ğŸ˜°', anxious:'ğŸ˜°', excitado:'ğŸ¤©', excited:'ğŸ¤©', asustado:'ğŸ˜¨', scared:'ğŸ˜¨', alerta:'ğŸ‘€', alert:'ğŸ‘€', jugueton:'ğŸ¾', playful:'ğŸ¾', dolorido:'ğŸ˜¢', painful:'ğŸ˜¢', agresivo:'âš ï¸', aggressive:'âš ï¸', tranquilo:'ğŸ˜Œ', calm:'ğŸ˜Œ', frustrado:'ğŸ˜¤', frustrated:'ğŸ˜¤' };

// â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  document.getElementById('formLogin').style.display = tab === 'login' ? '' : 'none';
  document.getElementById('formRegister').style.display = tab === 'register' ? '' : 'none';
  document.querySelectorAll('.auth-tab').forEach((t,i) => t.classList.toggle('active', (tab==='login'&&i===0)||(tab==='register'&&i===1)));
  document.getElementById('authError').style.display = 'none';
}

async function login() {
  const email = document.getElementById('loginEmail').value;
  const pass = document.getElementById('loginPass').value;
  const r = await fetch(`${API}/auth/login`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({email,password:pass}) });
  const d = await r.json();
  if (!r.ok) return showAuthError(d.error);
  saveToken(d.token, d.user);
}

async function register() {
  const name = document.getElementById('regName').value;
  const email = document.getElementById('regEmail').value;
  const pass = document.getElementById('regPass').value;
  const r = await fetch(`${API}/auth/register`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name,email,password:pass}) });
  const d = await r.json();
  if (!r.ok) return showAuthError(d.error);
  saveToken(d.token, d.user);
}

function saveToken(t, user) {
  token = t; currentUser = user;
  localStorage.setItem('guauai_token', t);
  initApp();
}

function showAuthError(msg) {
  const el = document.getElementById('authError');
  el.textContent = msg; el.style.display = 'block';
}

function logout() {
  localStorage.removeItem('guauai_token');
  token = null; currentUser = null;
  document.getElementById('app').style.display = 'none';
  document.getElementById('authScreen').style.display = 'flex';
}

async function initApp() {
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  if (!currentUser) {
    const r = await fetch(`${API}/auth/me`, { headers:{ Authorization:`Bearer ${token}` } });
    if (!r.ok) return logout();
    currentUser = await r.json();
  }
  document.getElementById('userName').textContent = currentUser.name || currentUser.email;
  document.getElementById('userAvatar').textContent = (currentUser.name || currentUser.email)[0].toUpperCase();
  const tu = document.getElementById('topbarUser');
  if (tu) tu.textContent = currentUser.name || currentUser.email.split('@')[0];
  await loadDogs();
  loadOverview();
}

// â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function navigate(page, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
  document.getElementById(`page-${page}`)?.classList.add('active');
  if (el) el.classList.add('active');
  else document.querySelector(`[data-page="${page}"]`)?.classList.add('active');
  if (page === 'history') loadFullHistory();
  if (page === 'overview') loadOverview();
  if (page === 'dogs') renderDogGrid();
  if (page === 'analyzer') populateAnalyzerDogs();
  if (page === 'alerts') loadAlerts();
  // Cerrar sidebar en mÃ³vil tras navegar
  if (window.innerWidth <= 768) {
    document.getElementById('sidebar')?.classList.remove('open');
    document.getElementById('sidebarOverlay')?.classList.remove('open');
  }
}

// â”€â”€ DOGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDogs() {
  const r = await fetch(`${API}/dogs`, { headers:{ Authorization:`Bearer ${token}` } });
  dogs = r.ok ? await r.json() : [];
}

function renderDogGrid() {
  const grid = document.getElementById('dogGrid');
  grid.innerHTML = dogs.map(d => `
    <div class="dog-card" onclick="openDogDetail('${d.id}')">
      <div class="dog-card-top">
        <div class="dog-avatar" style="${d.photo_url ? 'overflow:hidden;padding:0' : ''}">${d.photo_url ? `<img src="${d.photo_url}" style="width:100%;height:100%;object-fit:cover"/>` : 'ğŸ¶'}</div>
        <div><div class="dog-name">${d.name}</div><div class="dog-breed">${d.breed||'Raza no especificada'}</div></div>
      </div>
      <div class="dog-stats-row">
        <div>AnÃ¡lisis: <strong>${d.analyses_30d||0}</strong> este mes</div>
        <div>Total: <strong>${d.total_analyses||0}</strong></div>
      </div>
    </div>
  `).join('') + `<div class="add-dog-card" onclick="openAddDog()"><span>ğŸ¾</span>AÃ±adir perro</div>`;
}

function openAddDog() {
  document.getElementById('dogModalTitle').textContent = 'AÃ±adir perro';
  document.getElementById('dogModalId').value = '';
  document.getElementById('dogModalPhoto').value = '';
  ['Name','Breed','Birth','Weight','Notes'].forEach(f => document.getElementById(`dogModal${f}`).value = '');
  const prev = document.getElementById('dogPhotoPreview');
  prev.innerHTML = 'ğŸ¶'; prev.style.backgroundImage = '';
  document.getElementById('dogModal').classList.add('open');
}

function closeDogModal() { document.getElementById('dogModal').classList.remove('open'); }

// CompresiÃ³n de foto client-side con Canvas (mÃ¡x 300x300 JPEG 0.75)
function handlePhotoUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  if (file.size > 5 * 1024 * 1024) { showToast('Imagen demasiado grande (mÃ¡x 5MB)'); return; }
  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      const MAX = 300;
      let w = img.width, h = img.height;
      if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
      else { w = Math.round(w * MAX / h); h = MAX; }
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.75);
      document.getElementById('dogModalPhoto').value = dataUrl;
      const prev = document.getElementById('dogPhotoPreview');
      prev.innerHTML = `<img src="${dataUrl}" style="width:100%;height:100%;object-fit:cover"/>`;
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

async function saveDog() {
  const id = document.getElementById('dogModalId').value;
  const photoVal = document.getElementById('dogModalPhoto').value;
  const body = {
    name: document.getElementById('dogModalName').value,
    breed: document.getElementById('dogModalBreed').value || null,
    birth_date: document.getElementById('dogModalBirth').value || null,
    weight_kg: document.getElementById('dogModalWeight').value || null,
    notes: document.getElementById('dogModalNotes').value || null,
    photo_url: photoVal || undefined,
  };
  if (!body.name) return alert('El nombre es obligatorio');
  const url = id ? `${API}/dogs/${id}` : `${API}/dogs`;
  const method = id ? 'PATCH' : 'POST';
  const r = await fetch(url, { method, headers:{'Content-Type':'application/json', Authorization:`Bearer ${token}`}, body: JSON.stringify(body) });
  if (r.ok) {
    closeDogModal(); await loadDogs(); renderDogGrid(); showToast('âœ… Guardado');
  } else {
    const e = await r.json(); alert(e.error);
  }
}

// â”€â”€ DOG DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openDogDetail(id) {
  const dog = dogs.find(d => d.id === id);
  if (!dog) return;
  navigate('dogdetail', null);

  document.getElementById('dogDetailHeader').innerHTML = `
    <div style="display:flex;align-items:center;gap:1.5rem;margin-bottom:2rem">
      <div class="dog-avatar" style="width:72px;height:72px;font-size:2rem;${dog.photo_url ? 'overflow:hidden;padding:0' : ''}">${dog.photo_url ? `<img src="${dog.photo_url}" style="width:100%;height:100%;object-fit:cover"/>` : 'ğŸ¶'}</div>
      <div>
        <h2 style="font-size:1.75rem;font-weight:800">${dog.name}</h2>
        <p style="color:var(--muted)">${dog.breed||''} Â· ${dog.total_analyses||0} anÃ¡lisis en total</p>
      </div>
      <button class="btn-sm btn-outline" style="margin-left:auto" onclick="editDog('${dog.id}')">âœï¸ Editar</button>
    </div>`;

  const [statsR, histR] = await Promise.all([
    fetch(`${API}/dogs/${id}/stats`, { headers:{ Authorization:`Bearer ${token}` } }),
    fetch(`${API}/dogs/${id}/history?limit=50`, { headers:{ Authorization:`Bearer ${token}` } })
  ]);
  const stats = statsR.ok ? await statsR.json() : {};
  const hist  = histR.ok  ? await histR.json()  : [];

  // Charts
  document.getElementById('dogDetailCharts').innerHTML = `
    <div class="chart-card"><h4>Emociones (30 dÃ­as)</h4><div style="position:relative;height:180px"><canvas id="detailChartEmotions"></canvas></div></div>
    <div class="chart-card"><h4>AnÃ¡lisis por dÃ­a</h4><div style="position:relative;height:180px"><canvas id="detailChartTimeline"></canvas></div></div>`;

  if (stats.emotions?.length) {
    new Chart(document.getElementById('detailChartEmotions'), {
      type: 'doughnut',
      data: { labels: stats.emotions.map(e=>e.estado_emocional), datasets: [{ data: stats.emotions.map(e=>e.n), backgroundColor: ['#7c3aed','#a855f7','#10b981','#f59e0b','#ef4444','#3b82f6','#ec4899','#14b8a6','#f97316','#84cc16'] }] },
      options: { plugins:{ legend:{ position:'right', labels:{ color:'#f1f5f9', font:{size:11} } } }, maintainAspectRatio:false }
    });
  }
  if (stats.timeline?.length) {
    new Chart(document.getElementById('detailChartTimeline'), {
      type: 'bar',
      data: { labels: stats.timeline.map(t=>new Date(t.day).toLocaleDateString('es',{month:'short',day:'numeric'})), datasets: [{ data: stats.timeline.map(t=>t.n), backgroundColor:'#7c3aed55', borderColor:'#7c3aed', borderWidth:2, borderRadius:4 }] },
      options: { plugins:{ legend:{display:false} }, scales:{ x:{ticks:{color:'#64748b'},grid:{color:'#1e1e30'}}, y:{ticks:{color:'#64748b'},grid:{color:'#1e1e30'}} }, maintainAspectRatio:false }
    });
  }

  // Table
  document.getElementById('dogDetailBody').innerHTML = hist.length
    ? hist.map(a => rowHtml(a, false)).join('')
    : '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--muted)">Sin anÃ¡lisis todavÃ­a</td></tr>';
}

function editDog(id) {
  const d = dogs.find(x => x.id === id);
  if (!d) return;
  document.getElementById('dogModalTitle').textContent = 'Editar perro';
  document.getElementById('dogModalId').value = d.id;
  document.getElementById('dogModalName').value = d.name;
  document.getElementById('dogModalBreed').value = d.breed || '';
  document.getElementById('dogModalBirth').value = d.birth_date?.slice(0,10) || '';
  document.getElementById('dogModalWeight').value = d.weight_kg || '';
  document.getElementById('dogModalNotes').value = d.notes || '';
  document.getElementById('dogModalPhoto').value = '';
  const prev = document.getElementById('dogPhotoPreview');
  if (d.photo_url) {
    prev.innerHTML = `<img src="${d.photo_url}" style="width:100%;height:100%;object-fit:cover"/>`;
  } else {
    prev.innerHTML = 'ğŸ¶';
  }
  document.getElementById('dogModal').classList.add('open');
}

// â”€â”€ OVERVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadOverview() {
  document.getElementById('totalDogs').textContent = dogs.length;
  if (!dogs.length) return;

  const totals = dogs.reduce((acc,d) => { acc.total += (d.total_analyses||0); acc.last = d.last_analysis || acc.last; return acc; }, {total:0, last:null});
  document.getElementById('totalAnalyses').textContent = totals.total;
  document.getElementById('lastAnalysis').textContent = totals.last ? new Date(totals.last).toLocaleDateString('es') : 'â€”';

  // Agregar stats de todos los perros
  const allStats = await Promise.all(dogs.map(d => fetch(`${API}/dogs/${d.id}/stats`,{headers:{Authorization:`Bearer ${token}`}}).then(r=>r.ok?r.json():{})));
  const emotionMap = {};
  const timelineMap = {};
  allStats.forEach(s => {
    (s.emotions||[]).forEach(e => { emotionMap[e.estado_emocional] = (emotionMap[e.estado_emocional]||0) + parseInt(e.n); });
    (s.timeline||[]).forEach(t => { const k=t.day?.slice(0,10); if(k) timelineMap[k] = (timelineMap[k]||0) + parseInt(t.n); });
  });
  const top = Object.entries(emotionMap).sort((a,b)=>b[1]-a[1])[0];
  document.getElementById('topEmotion').textContent = top ? `${EMOTION_EMOJI[top[0]]||'ğŸ¶'} ${top[0]}` : 'â€”';

  // Emotion chart
  const ectx = document.getElementById('chartEmotions');
  if (emotionChart) emotionChart.destroy();
  emotionChart = new Chart(ectx, {
    type:'doughnut',
    data:{ labels:Object.keys(emotionMap), datasets:[{data:Object.values(emotionMap), backgroundColor:['#7c3aed','#a855f7','#10b981','#f59e0b','#ef4444','#3b82f6','#ec4899','#14b8a6','#f97316','#84cc16']}] },
    options:{ plugins:{legend:{position:'right',labels:{color:'#f1f5f9',font:{size:11}}}}, maintainAspectRatio:false }
  });

  // Timeline chart
  const tctx = document.getElementById('chartTimeline');
  if (timelineChart) timelineChart.destroy();
  const sortedDays = Object.keys(timelineMap).sort();
  timelineChart = new Chart(tctx, {
    type:'line',
    data:{ labels:sortedDays.map(d=>new Date(d).toLocaleDateString('es',{month:'short',day:'numeric'})), datasets:[{data:sortedDays.map(d=>timelineMap[d]), borderColor:'#7c3aed', backgroundColor:'#7c3aed22', fill:true, tension:0.4, pointRadius:3}] },
    options:{ plugins:{legend:{display:false}}, scales:{x:{ticks:{color:'#64748b'},grid:{color:'#1e1e30'}},y:{ticks:{color:'#64748b'},grid:{color:'#1e1e30'}}}, maintainAspectRatio:false }
  });
}

// â”€â”€ HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadFullHistory() {
  const all = await Promise.all(dogs.map(d =>
    fetch(`${API}/dogs/${d.id}/history?limit=100`, {headers:{Authorization:`Bearer ${token}`}}).then(r=>r.ok?r.json():[]).then(rows=>rows.map(r=>({...r,_dogName:d.name})))
  ));
  const flat = all.flat().sort((a,b) => new Date(b.created_at)-new Date(a.created_at));
  document.getElementById('historyBody').innerHTML = flat.length
    ? flat.map(a => rowHtml(a, true)).join('')
    : '<tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--muted)">Sin anÃ¡lisis todavÃ­a</td></tr>';
  window._allHistory = flat;
}

function rowHtml(a, withDog) {
  const emoji = EMOTION_EMOJI[a.estado_emocional] || 'ğŸ¶';
  const badgeClass = `badge-${a.estado_emocional?.replace(/[Ã¡Ã©Ã­Ã³Ãº]/g,c=>({Ã¡:'a',Ã©:'e',Ã­:'i',Ã³:'o',Ãº:'u'}[c]))||'default'}`;
  const conf = a.confianza ? `${Math.round(a.confianza*100)}%` : 'â€”';
  const date = new Date(a.created_at).toLocaleString('es',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
  const shareable = `${location.origin}/share/${a.id}`;
  return `<tr>
    <td style="color:var(--muted);white-space:nowrap">${date}</td>
    ${withDog ? `<td class="col-hide" style="font-weight:600">${a._dogName||'â€”'}</td>` : ''}
    <td><span class="badge ${badgeClass}">${emoji} ${a.estado_emocional||'â€”'}</span></td>
    <td class="col-hide">${a.necesidad||'â€”'}</td>
    <td class="col-hide">${a.intensidad||'â€”'}</td>
    <td style="color:var(--green)">${conf}</td>
    <td style="max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${a.mensaje_interpretado||''}">"${a.mensaje_interpretado||'â€”'}"</td>
    <td><button class="btn-sm btn-outline" style="padding:.25rem .5rem;font-size:.7rem" onclick="shareAnalysis('${shareable}')">ğŸ”—</button></td>
  </tr>`;
}

function shareAnalysis(url) {
  navigator.clipboard?.writeText(url).then(() => showToast('ğŸ”— Link copiado al portapapeles'));
}

// â”€â”€ VET SHARE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function shareWithVet() {
  try {
    const r = await fetch('/api/vet/my-token', { headers: { Authorization: `Bearer ${token}` } });
    if (!r.ok) { showToast('Error al generar enlace'); return; }
    const { url } = await r.json();
    if (navigator.clipboard) {
      await navigator.clipboard.writeText(url);
      showToast('ğŸ©º Enlace copiado â€” compÃ¡rtelo con tu veterinario o entrenador');
    } else {
      prompt('Copia este enlace para tu veterinario:', url);
    }
  } catch (e) { showToast('Error: ' + e.message); }
}

function exportAll() {
  if (!window._allHistory?.length) return;
  const csv = ['Fecha,Perro,EmociÃ³n,Necesidad,Intensidad,Confianza,Mensaje']
    .concat(window._allHistory.map(a => `"${new Date(a.created_at).toLocaleString('es')}","${a._dogName||''}","${a.estado_emocional||''}","${a.necesidad||''}","${a.intensidad||''}","${a.confianza||''}","${(a.mensaje_interpretado||'').replace(/"/g,"'")}"`))
    .join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `guauai_historial_${new Date().toISOString().slice(0,10)}.csv`; a.click();
}

function populateAnalyzerDogs() {
  const sel = document.getElementById('analyzerDog');
  sel.innerHTML = '<option value="">Sin asociar</option>' + dogs.map(d=>`<option value="${d.id}">${d.name}</option>`).join('');
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// â”€â”€ ALERTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAlerts() {
  const r = await fetch(`${API}/alerts`, { headers:{ Authorization:`Bearer ${token}` } });
  const alerts = r.ok ? await r.json() : [];
  const el = document.getElementById('alertsList');
  if (!alerts.length) {
    el.innerHTML = `<div class="empty"><span>âœ…</span><p>Sin alertas recientes. Todo parece bien.</p></div>`;
    return;
  }
  el.innerHTML = alerts.map(a => `
    <div class="card" style="margin-bottom:1rem;border-left:4px solid var(--red)">
      <div style="display:flex;align-items:center;gap:1rem">
        <div style="font-size:1.5rem">âš ï¸</div>
        <div>
          <div style="font-weight:700">${a.dog_name} â€” ${a.estado_emocional?.toUpperCase()}</div>
          <div style="color:var(--muted);font-size:.85rem">${new Date(a.created_at).toLocaleString('es')}</div>
          <div style="margin-top:.5rem;font-size:.9rem">"${a.mensaje_interpretado||''}"</div>
        </div>
      </div>
    </div>
  `).join('');
}

// â”€â”€ RECORDER INTEGRADO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  const EMOTION_EMOJI = { ansioso:'ğŸ˜°',tranquilo:'ğŸ˜Œ',excitado:'ğŸ¤©',asustado:'ğŸ˜¨',alerta:'âš¡',juguetÃ³n:'ğŸ¾',dolorido:'ğŸ¤•',agresivo:'ğŸ˜¡',frustrado:'ğŸ˜¤',feliz:'ğŸ˜„',happy:'ğŸ˜„',anxious:'ğŸ˜°',scared:'ğŸ˜¨',excited:'ğŸ¤©',playful:'ğŸ¾',painful:'ğŸ¤•',calm:'ğŸ˜Œ',alert:'âš¡' };
  let mrec = null, chunks = [], blob = null, timerIv = null, secs = 0, animId = null;

  const recBtn = document.getElementById('recBtn');
  const recAnalyzeBtn = document.getElementById('recAnalyzeBtn');
  const recTimer = document.getElementById('recTimer');
  const recStatus = document.getElementById('recStatus');
  const recLoader = document.getElementById('recLoader');
  const recError = document.getElementById('recError');
  const recResult = document.getElementById('recResult');
  const recCanvas = document.getElementById('recWaveform');
  const rctx = recCanvas ? recCanvas.getContext('2d') : null;

  function resizeRec() {
    if (!recCanvas) return;
    recCanvas.width = recCanvas.offsetWidth * devicePixelRatio;
    recCanvas.height = recCanvas.offsetHeight * devicePixelRatio;
    rctx.scale(devicePixelRatio, devicePixelRatio);
    drawIdle();
  }
  function drawIdle() {
    if (!rctx) return;
    const w = recCanvas.offsetWidth, h = recCanvas.offsetHeight;
    rctx.clearRect(0,0,w,h);
    rctx.strokeStyle = 'rgba(124,58,237,.2)'; rctx.lineWidth = 1.5;
    rctx.beginPath(); rctx.moveTo(0,h/2); rctx.lineTo(w,h/2); rctx.stroke();
  }
  function drawWave(data) {
    if (!rctx) return;
    const w = recCanvas.offsetWidth, h = recCanvas.offsetHeight;
    rctx.clearRect(0,0,w,h);
    rctx.strokeStyle = 'rgba(168,85,247,.8)'; rctx.lineWidth = 2;
    rctx.beginPath();
    const sw = w / data.length; let x = 0;
    for (let i = 0; i < data.length; i++) {
      const y = (data[i]/128.0*h)/2;
      i===0 ? rctx.moveTo(x,y) : rctx.lineTo(x,y); x+=sw;
    }
    rctx.lineTo(w,h/2); rctx.stroke();
  }
  function fmt(s) { return String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0'); }

  if (recBtn) recBtn.addEventListener('click', async () => {
    if (mrec && mrec.state === 'recording') { stopRec(); return; }
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const actx = new AudioContext();
      const src = actx.createMediaStreamSource(stream);
      const an = actx.createAnalyser(); an.fftSize = 512;
      src.connect(an);
      const da = new Uint8Array(an.frequencyBinCount);
      const loop = () => { an.getByteTimeDomainData(da); drawWave(da); animId = requestAnimationFrame(loop); };
      loop();
      chunks = []; mrec = new MediaRecorder(stream, { mimeType:'audio/webm' });
      mrec.ondataavailable = e => { if (e.data.size>0) chunks.push(e.data); };
      mrec.onstop = () => { blob = new Blob(chunks,{type:'audio/webm'}); stream.getTracks().forEach(t=>t.stop()); cancelAnimationFrame(animId); drawIdle(); };
      mrec.start(100);
      recBtn.textContent = 'â¹ï¸'; recBtn.classList.add('recording');
      recStatus.textContent = (DASH_TRANSLATIONS[localStorage.getItem('guauai_lang')||navigator.language?.slice(0,2)||'es']||DASH_TRANSLATIONS.en).d_rec_recording || 'Grabando...';
      recAnalyzeBtn.classList.remove('visible'); recResult.classList.remove('visible');
      recError.classList.remove('visible');
      secs = 0; recTimer.textContent = '00:00'; recTimer.classList.add('recording');
      timerIv = setInterval(() => { secs++; recTimer.textContent = fmt(secs); if(secs>=30) stopRec(); }, 1000);
    } catch(e) { showRecError('No se pudo acceder al micrÃ³fono: ' + e.message); }
  });

  function stopRec() {
    if (mrec && mrec.state==='recording') mrec.stop();
    clearInterval(timerIv);
    recBtn.textContent = 'ğŸ™ï¸'; recBtn.classList.remove('recording');
    recTimer.classList.remove('recording');
    if (secs>0) { const _tR=(DASH_TRANSLATIONS[localStorage.getItem('guauai_lang')||navigator.language?.slice(0,2)||'es']||DASH_TRANSLATIONS.en); recStatus.textContent = `${_tR.d_rec_ready||'Audio listo'} (${fmt(secs)})`; recAnalyzeBtn.classList.add('visible'); }
    else { const _ti=(DASH_TRANSLATIONS[localStorage.getItem('guauai_lang')||navigator.language?.slice(0,2)||'es']||DASH_TRANSLATIONS.en); recStatus.textContent = _ti.d_rec_idle; }
  }

  if (recAnalyzeBtn) recAnalyzeBtn.addEventListener('click', async () => {
    if (!blob) return;
    recAnalyzeBtn.disabled = true;
    recLoader.classList.add('visible');
    recResult.classList.remove('visible');
    recError.classList.remove('visible');
    const reader = new FileReader();
    reader.readAsDataURL(blob);
    reader.onloadend = async () => {
      try {
        const b64 = reader.result.split(',')[1];
        const dogId = document.getElementById('analyzerDog')?.value || null;
        const dogOpt = document.getElementById('analyzerDog');
        const dogName = dogOpt && dogOpt.selectedIndex > 0 ? dogOpt.options[dogOpt.selectedIndex].text.split(' (')[0] : 'Mi perro';
        const headers = {'Content-Type':'application/json'};
        if (token) headers['Authorization'] = `Bearer ${token}`;
        const res = await fetch('/api/audio/analyze-base64', {
          method:'POST', headers,
          body: JSON.stringify({ audio_base64:b64, mime_type:'audio/webm', lang: navigator.language?.slice(0,2)||'es', dog_name:dogName, dog_id:dogId||undefined })
        });
        recLoader.classList.remove('visible');
        if (!res.ok) { const e=await res.json(); showRecError(e.error||'Error al analizar'); recAnalyzeBtn.disabled=false; return; }
        const data = await res.json();
        renderRecResult(data);
        recAnalyzeBtn.classList.remove('visible');
        recAnalyzeBtn.disabled = false;
        // Recargar historial si estÃ¡ visible
        if (document.getElementById('page-history')?.classList.contains('active')) loadFullHistory();
      } catch(e) { recLoader.classList.remove('visible'); recAnalyzeBtn.disabled=false; showRecError('Error de conexiÃ³n: '+e.message); }
    };
  });

  function renderRecResult(data) {
    const a = data.analysis;
    const emoji = EMOTION_EMOJI[a.estado_emocional] || 'ğŸ¶';
    const conf = Math.round((a.confianza||0)*100);
    recResult.innerHTML = `
      <div class="emo-badge">${emoji} ${(a.estado_emocional||'').toUpperCase()}</div>
      <div class="msg-bubble"><p>"${a.mensaje_interpretado||'...'}"</p></div>
      <div class="rec-meta">
        <div class="rec-meta-item"><div class="lbl">${(DASH_TRANSLATIONS[localStorage.getItem('guauai_lang')||navigator.language?.slice(0,2)||'es']||DASH_TRANSLATIONS.en).d_label_need||'Necesidad'}</div><div class="val">${a.necesidad||'â€”'}</div></div>
        <div class="rec-meta-item"><div class="lbl">${(DASH_TRANSLATIONS[localStorage.getItem('guauai_lang')||navigator.language?.slice(0,2)||'es']||DASH_TRANSLATIONS.en).d_label_vocal||'VocalizaciÃ³n'}</div><div class="val">${a.tipo_vocalizacion||'â€”'}</div></div>
        <div class="rec-meta-item"><div class="lbl">${(DASH_TRANSLATIONS[localStorage.getItem('guauai_lang')||navigator.language?.slice(0,2)||'es']||DASH_TRANSLATIONS.en).d_label_inten||'Intensidad'}</div><div class="val">${(a.intensidad||'â€”').toUpperCase()}</div></div>
        <div class="rec-meta-item"><div class="lbl">${(DASH_TRANSLATIONS[localStorage.getItem('guauai_lang')||navigator.language?.slice(0,2)||'es']||DASH_TRANSLATIONS.en).d_label_conf||'Confianza'}</div><div class="val">${conf}%</div><div class="conf-bar"><div class="conf-fill" style="width:${conf}%"></div></div></div>
      </div>
      ${a.recomendacion_dueno ? `<div class="rec-reco"><span>ğŸ’¡</span><span>${a.recomendacion_dueno}</span></div>` : ''}
      <button class="try-btn" onclick="recReset()">ğŸ”„ ${ (DASH_TRANSLATIONS[localStorage.getItem('guauai_lang')||navigator.language?.slice(0,2)||'es']||DASH_TRANSLATIONS.en).d_try_again||'Grabar de nuevo' }</button>`;
    recResult.classList.add('visible');
  }

  function showRecError(msg) { recError.textContent = 'âš ï¸ '+msg; recError.classList.add('visible'); }

  window.recReset = function() {
    blob = null; secs = 0; recTimer.textContent='00:00';
    recStatus.textContent=(DASH_TRANSLATIONS[localStorage.getItem('guauai_lang')||navigator.language?.slice(0,2)||'es']||DASH_TRANSLATIONS.en).d_rec_idle;
    recAnalyzeBtn.classList.remove('visible');
    recResult.classList.remove('visible');
    recError.classList.remove('visible');
    drawIdle();
  };

  window.addEventListener('resize', resizeRec);
  // Init cuando el canvas estÃ© visible (al navegar a la pestaÃ±a)
  const origNav = window.navigate;
  window.navigate = function(page, el) {
    origNav && origNav(page, el);
    if (page === 'analyzer') setTimeout(resizeRec, 50);
  };
  setTimeout(resizeRec, 100);
})();

// â”€â”€ SIDEBAR MÃ“VIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('open');
}
// Topbar responsive
function checkTopbar() {
  const tb = document.getElementById('topbar');
  tb.style.display = window.innerWidth <= 768 ? 'flex' : 'none';
}
window.addEventListener('resize', checkTopbar);
checkTopbar();

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (token) initApp();
</script>

<div id="pwaPrompt">
  <div class="pwa-text"><strong>ğŸ“² Instalar GuauAI</strong>Acceso directo desde tu mÃ³vil, sin navegador</div>
  <button class="pwa-install" onclick="installPWA()">Instalar</button>
  <button class="pwa-dismiss" onclick="dismissPWA()" aria-label="Cerrar">âœ•</button>
</div>
<script>
// â”€â”€ PWA Install Prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _pwaPrompt;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  _pwaPrompt = e;
  const el = document.getElementById('pwaPrompt');
  if (el && localStorage.getItem('pwa_dismissed') !== '1') {
    setTimeout(() => { el.style.display = 'flex'; }, 3000);
  }
});
window.installPWA = async function() {
  if (!_pwaPrompt) return;
  _pwaPrompt.prompt();
  const { outcome } = await _pwaPrompt.userChoice;
  document.getElementById('pwaPrompt').style.display = 'none';
  _pwaPrompt = null;
};
window.dismissPWA = function() {
  document.getElementById('pwaPrompt').style.display = 'none';
  localStorage.setItem('pwa_dismissed', '1');
};
// â”€â”€ Dashboard i18n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DASH_LANG = localStorage.getItem('guauai_lang') || navigator.language?.slice(0,2) || 'es';
const DASH_TRANSLATIONS = {
  es: {
    d_login:'Entrar', d_register:'Registrarse', d_email:'Email', d_pass:'ContraseÃ±a',
    d_name:'Nombre', d_login_btn:'Entrar â†’', d_reg_btn:'Crear cuenta â†’', d_logout:'Cerrar sesiÃ³n',
    d_nav_overview:'Resumen', d_nav_dogs:'Mis Perros', d_nav_analyze:'Analizar',
    d_nav_history:'Historial', d_nav_alerts:'Alertas',
    d_nav_analyze_title:'Analizar Sonido', d_nav_history_title:'Historial completo',
    d_nav_alerts_title:'ğŸ”” Alertas de Comportamiento',
    d_stat_dogs:'Perros', d_stat_analyses:'AnÃ¡lisis totales',
    d_stat_emotion:'EmociÃ³n frecuente', d_stat_last:'Ãšltimo anÃ¡lisis',
    d_chart_emotions:'Emociones (30 dÃ­as)', d_chart_activity:'Actividad diaria',
    d_add_dog:'+ AÃ±adir perro', d_add_dog_card:'AÃ±adir perro',
    d_back_dogs:'â† Volver a Mis Perros', d_export:'ğŸ“¥ Exportar CSV',
    d_share_vet:'Compartir con vet',
    d_rec_idle:'Pulsa para grabar el sonido de tu perro',
    d_rec_analyze:'ğŸ” Analizar lo que dice', d_rec_loading:'Analizando vocalizaciones...',
    d_no_dog:'Sin asociar',
        d_tagline:'Habla con tu perro',
    d_rec_recording:'Grabando... pulsa para detener',
    d_rec_ready:'Audio listo',
    d_try_again:'Grabar de nuevo',
    d_label_need:'Necesidad', d_label_vocal:'VocalizaciÃ³n', d_label_inten:'Intensidad', d_label_conf:'Confianza',
  },
  en: {
    d_login:'Sign in', d_register:'Sign up', d_email:'Email', d_pass:'Password',
    d_name:'Name', d_login_btn:'Sign in â†’', d_reg_btn:'Create account â†’', d_logout:'Sign out',
    d_nav_overview:'Overview', d_nav_dogs:'My Dogs', d_nav_analyze:'Analyze',
    d_nav_history:'History', d_nav_alerts:'Alerts',
    d_nav_analyze_title:'Analyze Sound', d_nav_history_title:'Full history',
    d_nav_alerts_title:'ğŸ”” Behavior Alerts',
    d_stat_dogs:'Dogs', d_stat_analyses:'Total analyses',
    d_stat_emotion:'Top emotion', d_stat_last:'Last analysis',
    d_chart_emotions:'Emotions (30 days)', d_chart_activity:'Daily activity',
    d_add_dog:'+ Add dog', d_add_dog_card:'Add dog',
    d_back_dogs:'â† Back to My Dogs', d_export:'ğŸ“¥ Export CSV',
    d_share_vet:'Share with vet',
    d_rec_idle:'Press to record your dog's sound',
    d_rec_analyze:'ğŸ” Analyze what they said', d_rec_loading:'Analyzing vocalizations...',
    d_no_dog:'No dog linked',
        d_tagline:'Talk to your dog',
    d_rec_recording:'Recording... press to stop',
    d_rec_ready:'Audio ready',
    d_try_again:'Record again',
    d_label_need:'Need', d_label_vocal:'Vocalization', d_label_inten:'Intensity', d_label_conf:'Confidence',
  },
  pt: {
    d_login:'Entrar', d_register:'Registar', d_email:'Email', d_pass:'Senha',
    d_name:'Nome', d_login_btn:'Entrar â†’', d_reg_btn:'Criar conta â†’', d_logout:'Sair',
    d_nav_overview:'Resumo', d_nav_dogs:'Meus CÃ£es', d_nav_analyze:'Analisar',
    d_nav_history:'HistÃ³rico', d_nav_alerts:'Alertas',
    d_nav_analyze_title:'Analisar Som', d_nav_history_title:'HistÃ³rico completo',
    d_nav_alerts_title:'ğŸ”” Alertas de Comportamento',
    d_stat_dogs:'CÃ£es', d_stat_analyses:'AnÃ¡lises totais',
    d_stat_emotion:'EmoÃ§Ã£o frequente', d_stat_last:'Ãšltima anÃ¡lise',
    d_chart_emotions:'EmoÃ§Ãµes (30 dias)', d_chart_activity:'Atividade diÃ¡ria',
    d_add_dog:'+ Adicionar cÃ£o', d_add_dog_card:'Adicionar cÃ£o',
    d_back_dogs:'â† Voltar a Meus CÃ£es', d_export:'ğŸ“¥ Exportar CSV',
    d_share_vet:'Partilhar com vet',
    d_rec_idle:'Pressione para gravar o som do seu cÃ£o',
    d_rec_analyze:'ğŸ” Analisar o que ele disse', d_rec_loading:'Analisando vocalizaÃ§Ãµes...',
    d_no_dog:'Sem cÃ£o associado',
        d_tagline:'Fale com o seu cÃ£o',
    d_rec_recording:'Gravando... pressione para parar',
    d_rec_ready:'Ãudio pronto',
    d_try_again:'Gravar novamente',
    d_label_need:'Necessidade', d_label_vocal:'VocalizaÃ§Ã£o', d_label_inten:'Intensidade', d_label_conf:'ConfianÃ§a',
  },
};

function applyDashI18n(lang) {
  const t = DASH_TRANSLATIONS[lang] || DASH_TRANSLATIONS.en;
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (t[key] !== undefined) el.textContent = t[key];
  });
  // Highlight active lang button
  ['es','en','pt'].forEach(l => {
    const btn = document.getElementById('lang'+l.charAt(0).toUpperCase()+l.slice(1));
    if (btn) btn.style.opacity = l === lang ? '1' : '0.4';
  });
  // Update placeholders
  const loginPass = document.getElementById('loginPass');
  if (loginPass) loginPass.placeholder = lang === 'en' ? 'Min 6 characters' : lang === 'pt' ? 'MÃ­n 6 caracteres' : 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
  const recStatus = document.getElementById('recStatus');
  if (recStatus && recStatus.getAttribute('data-i18n')) recStatus.textContent = t.d_rec_idle;
}

window.setLang = function(lang) {
  localStorage.setItem('guauai_lang', lang);
  applyDashI18n(lang);
};

document.addEventListener('DOMContentLoaded', () => applyDashI18n(DASH_LANG));

</script>
</body>
</html>
